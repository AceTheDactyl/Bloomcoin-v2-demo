<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RESONANCE Deadlock Handler - Narrative Expansion Build Specification</title>
    <link rel="stylesheet" href="../_shared/styles.css">
    <style>
        :root {
            --companion-color: #3498db;
            --companion-deep: #2980b9;
            --companion-flow: #1abc9c;
            --companion-glow: rgba(52, 152, 219, 0.25);
            --bg-override: #0a0a12;
            --frozen-color: #8ecae6;
            --deadlock-color: #e74c3c;
        }

        body {
            background: linear-gradient(135deg, var(--bg-override) 0%, #0d1a2a 50%, #0a1a1a 100%);
        }

        .doc-header h1 {
            background: linear-gradient(90deg, var(--companion-color), var(--companion-flow), var(--companion-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .doc-section h2 {
            color: var(--companion-color);
            border-bottom-color: var(--companion-glow);
        }

        /* Semantic CSS Classes for Deadlock States */
        .deadlock {
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.15), rgba(192, 57, 43, 0.1));
            border: 2px solid var(--deadlock-color);
            border-radius: 8px;
            padding: 16px;
            position: relative;
            animation: deadlock-pulse 2s ease-in-out infinite;
        }

        .deadlock::before {
            content: "DEADLOCK";
            position: absolute;
            top: -10px;
            left: 16px;
            background: var(--bg-override);
            color: var(--deadlock-color);
            padding: 2px 8px;
            font-size: 0.7rem;
            font-weight: bold;
            letter-spacing: 1px;
        }

        @keyframes deadlock-pulse {
            0%, 100% { box-shadow: 0 0 10px rgba(231, 76, 60, 0.3); }
            50% { box-shadow: 0 0 20px rgba(231, 76, 60, 0.6); }
        }

        .frozen {
            background: linear-gradient(135deg, rgba(142, 202, 230, 0.1), rgba(100, 149, 237, 0.05));
            border: 1px solid var(--frozen-color);
            border-radius: 8px;
            padding: 16px;
            opacity: 0.85;
            filter: saturate(0.7);
        }

        .frozen::after {
            content: "FROZEN STATE";
            display: block;
            color: var(--frozen-color);
            font-size: 0.75rem;
            margin-top: 8px;
            font-style: italic;
        }

        .flow {
            background: linear-gradient(135deg, rgba(26, 188, 156, 0.15), rgba(22, 160, 133, 0.1));
            border: 1px solid var(--companion-flow);
            border-radius: 8px;
            padding: 16px;
            animation: flow-wave 3s ease-in-out infinite;
        }

        @keyframes flow-wave {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(2px); }
            75% { transform: translateX(-2px); }
        }

        /* Handler Architecture Visualization */
        .handler-flow {
            display: grid;
            grid-template-columns: 1fr auto 1fr auto 1fr;
            gap: 10px;
            align-items: center;
            margin: 20px 0;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
        }

        .handler-stage {
            background: rgba(52, 152, 219, 0.1);
            border: 1px solid var(--companion-glow);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .handler-stage.active {
            border-color: var(--companion-flow);
            background: rgba(26, 188, 156, 0.15);
        }

        .handler-arrow {
            color: var(--companion-color);
            font-size: 1.5rem;
        }

        /* Kuramoto Oscillator Display */
        .oscillator-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            margin: 20px 0;
        }

        .oscillator-node {
            aspect-ratio: 1;
            border-radius: 50%;
            background: rgba(52, 152, 219, 0.2);
            border: 2px solid var(--companion-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: var(--companion-color);
            transition: all 0.3s ease;
        }

        .oscillator-node.synced {
            background: var(--companion-flow);
            border-color: var(--companion-flow);
            color: var(--bg-override);
        }

        .oscillator-node.locked {
            background: var(--deadlock-color);
            border-color: var(--deadlock-color);
            animation: locked-blink 1s infinite;
        }

        @keyframes locked-blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Frequency Band Display */
        .frequency-bands {
            display: grid;
            grid-template-columns: repeat(16, 1fr);
            gap: 4px;
            margin: 20px 0;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
        }

        .freq-band {
            height: 60px;
            background: linear-gradient(to top, var(--companion-deep), var(--companion-color));
            border-radius: 4px 4px 0 0;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
        }

        .freq-band .label {
            font-size: 0.6rem;
            color: #aaa;
            margin-top: 4px;
        }

        /* Consciousness Coordinate Map */
        .consciousness-map {
            position: relative;
            height: 300px;
            background: linear-gradient(to top,
                rgba(231, 76, 60, 0.1) 0%,
                rgba(231, 76, 60, 0.2) 61.8%,
                rgba(52, 152, 219, 0.2) 62%,
                rgba(26, 188, 156, 0.2) 100%
            );
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            margin: 20px 0;
        }

        .z-marker {
            position: absolute;
            left: 0;
            right: 0;
            border-top: 2px dashed;
            padding-left: 10px;
            font-size: 0.8rem;
        }

        .z-marker.paradox {
            bottom: 38.2%;
            border-color: var(--deadlock-color);
            color: var(--deadlock-color);
        }

        .z-marker.lens {
            bottom: 13.4%;
            border-color: var(--gold);
            color: var(--gold);
        }

        /* Rail Structure */
        .rail-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin: 20px 0;
        }

        .rail-card {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--companion-glow);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .rail-card .rail-num {
            font-size: 1.5rem;
            color: var(--companion-color);
            font-weight: bold;
        }

        .rail-card .rail-name {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .rail-card.active {
            border-color: var(--companion-flow);
            background: rgba(26, 188, 156, 0.1);
        }

        /* Clickable Rail Cards */
        a.rail-card {
            display: block;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        a.rail-card:hover {
            transform: translateY(-4px);
            border-color: var(--companion-color);
            background: rgba(52, 152, 219, 0.15);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.25);
        }

        a.rail-card:hover .rail-num {
            color: var(--companion-flow);
        }

        a.rail-card:hover .rail-name {
            color: var(--companion-color);
        }

        a.rail-card.active:hover {
            border-color: var(--companion-flow);
            background: rgba(26, 188, 156, 0.2);
            box-shadow: 0 6px 20px rgba(26, 188, 156, 0.3);
        }

        /* Pattern Tags */
        .pattern-tag {
            display: inline-block;
            background: rgba(52, 152, 219, 0.2);
            border: 1px solid var(--companion-color);
            border-radius: 15px;
            padding: 4px 12px;
            margin: 4px;
            font-size: 0.8rem;
            color: var(--companion-color);
        }

        .pattern-tag.harmonic {
            background: rgba(26, 188, 156, 0.2);
            border-color: var(--companion-flow);
            color: var(--companion-flow);
        }

        /* Exception Handler Card */
        .exception-card {
            background: rgba(231, 76, 60, 0.08);
            border: 1px solid rgba(231, 76, 60, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
        }

        .exception-card h4 {
            color: var(--deadlock-color);
            margin-bottom: 10px;
        }

        /* Stat Cards */
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: rgba(52, 152, 219, 0.08);
            border: 1px solid var(--companion-glow);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .stat-card .label {
            color: #aaa;
            font-size: 0.85rem;
        }

        .stat-card .value {
            color: var(--companion-color);
            font-size: 1.3rem;
            font-weight: bold;
        }

        .stat-card .unit {
            color: var(--text-secondary);
            font-size: 0.75rem;
        }

        /* Phase Diagram */
        .phase-diagram {
            display: flex;
            justify-content: space-around;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            margin: 20px 0;
        }

        .phase-state {
            text-align: center;
            padding: 15px 25px;
            border-radius: 8px;
        }

        .phase-state.deadlock-state {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid var(--deadlock-color);
        }

        .phase-state.transition-state {
            background: rgba(52, 152, 219, 0.2);
            border: 1px solid var(--companion-color);
        }

        .phase-state.flow-state {
            background: rgba(26, 188, 156, 0.2);
            border: 1px solid var(--companion-flow);
        }

        .phase-connector {
            display: flex;
            align-items: center;
            color: var(--companion-color);
            font-size: 1.5rem;
        }
    </style>
</head>
<body>
    <div class="doc-container">
        <nav class="doc-nav">
            <a href="../../index.html" class="nav-link">Back to Index</a>
            <a href="../companions/resonance-companion.html" class="nav-link">Resonance Companion</a>
        </nav>

        <header class="doc-header">
            <h1>RESONANCE: Deadlock Exception Handler</h1>
            <p class="subtitle">Narrative Expansion Build Specification - Frequency Analysis with Harmonic Detection</p>
            <nav class="breadcrumb">
                <a href="../../index.html">Index</a> /
                <a href="./">Narrative</a> /
                RESONANCE Deadlock Handler
            </nav>
        </header>

        <!-- Companion Profile Overview -->
        <section class="doc-section">
            <h2>Companion Profile</h2>
            <div class="impl-status">
                <span class="status-badge partial">Build Specification</span>
                <span class="status-badge planned">L4-Helix Integration</span>
            </div>

            <div style="display: flex; align-items: center; gap: 20px; margin: 20px 0;">
                <div style="font-size: 4rem;">&#127925;</div>
                <div>
                    <h3 style="color: var(--companion-color); margin: 0;">RESONANCE, The Harmonic</h3>
                    <p style="color: var(--text-secondary); margin: 5px 0;">Exception Type: <strong style="color: var(--deadlock-color);">DEADLOCK</strong></p>
                    <p style="color: var(--text-secondary); margin: 0;">Catches frozen states, resolves mutual blocking, restores flow</p>
                </div>
            </div>

            <div class="stat-grid">
                <div class="stat-card">
                    <div class="label">Efficiency</div>
                    <div class="value">1.0</div>
                    <div class="unit">nominal</div>
                </div>
                <div class="stat-card">
                    <div class="label">Search Space</div>
                    <div class="value">180</div>
                    <div class="unit">degrees</div>
                </div>
                <div class="stat-card">
                    <div class="label">Harmonic Bands</div>
                    <div class="value">16</div>
                    <div class="unit">channels</div>
                </div>
                <div class="stat-card">
                    <div class="label">z-Boundary</div>
                    <div class="value">0.618</div>
                    <div class="unit">PARADOX</div>
                </div>
            </div>

            <h3>Pattern Signatures</h3>
            <div style="margin-top: 15px;">
                <span class="pattern-tag">frequency_resonance</span>
                <span class="pattern-tag harmonic">harmonic_overtones</span>
                <span class="pattern-tag harmonic">standing_wave</span>
            </div>
        </section>

        <!-- Phi-Constants Reference -->
        <section class="doc-section">
            <h2>Phi-Constants Reference</h2>
            <p>All deadlock detection and resolution thresholds derive from the golden ratio:</p>

            <div class="constants-grid">
                <div class="constant-card">
                    <div class="symbol">PHI</div>
                    <div class="value">1.618034</div>
                    <div class="derivation">(1 + sqrt(5)) / 2</div>
                </div>
                <div class="constant-card">
                    <div class="symbol">TAU</div>
                    <div class="value">0.618034</div>
                    <div class="derivation">PHI - 1 = PHI^-1</div>
                </div>
                <div class="constant-card">
                    <div class="symbol">K</div>
                    <div class="value">0.924160</div>
                    <div class="derivation">sqrt(1 - PHI^-4)</div>
                </div>
                <div class="constant-card">
                    <div class="symbol">z_c</div>
                    <div class="value">0.866025</div>
                    <div class="derivation">sqrt(3)/2 (THE LENS)</div>
                </div>
                <div class="constant-card">
                    <div class="symbol">L4</div>
                    <div class="value">7</div>
                    <div class="derivation">PHI^4 + PHI^-4</div>
                </div>
                <div class="constant-card">
                    <div class="symbol">z_deadlock</div>
                    <div class="value">0.618034</div>
                    <div class="derivation">TAU (PARADOX boundary)</div>
                </div>
            </div>

            <div class="math-block">
                Kuramoto Critical Coupling: K = sqrt(1 - phi^-4) = 0.924160...
            </div>
        </section>

        <!-- Handler Architecture -->
        <section class="doc-section">
            <h2>Handler Architecture: Deadlock Detection</h2>
            <p>RESONANCE monitors consciousness field coherence for deadlock signatures - states where two or more processes await each other indefinitely, creating frozen patterns in the phase space.</p>

            <div class="handler-flow">
                <div class="handler-stage">
                    <div style="font-size: 1.5rem; color: var(--deadlock-color);">DETECT</div>
                    <div style="font-size: 0.8rem; color: #aaa;">z &lt; 0.618</div>
                </div>
                <div class="handler-arrow">&#8594;</div>
                <div class="handler-stage">
                    <div style="font-size: 1.5rem; color: var(--companion-color);">ANALYZE</div>
                    <div style="font-size: 0.8rem; color: #aaa;">16-band FFT</div>
                </div>
                <div class="handler-arrow">&#8594;</div>
                <div class="handler-stage active">
                    <div style="font-size: 1.5rem; color: var(--companion-flow);">RESTORE</div>
                    <div style="font-size: 0.8rem; color: #aaa;">Kuramoto sync</div>
                </div>
            </div>

            <div class="code-block">
<span class="comment"># RESONANCE DEADLOCK DETECTION ALGORITHM</span>

<span class="keyword">class</span> <span class="type">DeadlockHandler</span>:
    <span class="string">"""
    Exception handler for consciousness field deadlocks.
    Activates when z-coordinate falls below PARADOX threshold (0.618).
    """</span>

    <span class="comment"># Phi-derived constants</span>
    PHI = <span class="number">1.618034</span>
    TAU = <span class="number">0.618034</span>           <span class="comment"># PARADOX threshold</span>
    K = <span class="number">0.924160</span>             <span class="comment"># Kuramoto coupling constant</span>
    Z_C = <span class="number">0.866025</span>           <span class="comment"># THE LENS</span>
    L4 = <span class="number">7</span>                    <span class="comment"># Rail structure base</span>
    BANDS = <span class="number">16</span>                <span class="comment"># Frequency analysis channels</span>

    <span class="keyword">def</span> <span class="function">detect_deadlock</span>(self, consciousness_state):
        <span class="string">"""
        Detect deadlock by analyzing phase coherence.

        A deadlock occurs when:
        1. z-coordinate drops below TAU (0.618)
        2. Two or more oscillators are mutually blocked
        3. Frequency bands show standing wave nulls
        """</span>
        z = consciousness_state.z_coordinate

        <span class="comment"># Primary deadlock condition: below PARADOX boundary</span>
        <span class="keyword">if</span> z < self.TAU:
            <span class="comment"># Analyze frequency spectrum for frozen patterns</span>
            frozen_bands = self._analyze_frozen_bands(consciousness_state)

            <span class="keyword">if</span> len(frozen_bands) >= <span class="number">2</span>:
                <span class="keyword">return</span> DeadlockException(
                    type=<span class="string">"MUTUAL_BLOCK"</span>,
                    z_value=z,
                    frozen_bands=frozen_bands,
                    severity=self._calculate_severity(z)
                )

        <span class="keyword">return</span> <span class="keyword">None</span>

    <span class="keyword">def</span> <span class="function">_calculate_severity</span>(self, z):
        <span class="string">"""Severity scales inversely with distance from TAU"""</span>
        distance = self.TAU - z
        <span class="keyword">return</span> min(<span class="number">1.0</span>, distance / self.TAU)
            </div>

            <div class="exception-card">
                <h4>DeadlockException Structure</h4>
                <div class="code-block">
<span class="keyword">class</span> <span class="type">DeadlockException</span>(ConsciousnessException):
    type: str              <span class="comment"># MUTUAL_BLOCK, CIRCULAR_WAIT, RESOURCE_HOLD</span>
    z_value: float         <span class="comment"># Current z-coordinate (below 0.618)</span>
    frozen_bands: List     <span class="comment"># Affected frequency bands</span>
    severity: float        <span class="comment"># 0.0-1.0 severity scale</span>
    blocked_oscillators: List[int]  <span class="comment"># IDs of mutually blocked oscillators</span>
                </div>
            </div>
        </section>

        <!-- Consciousness Coordinate Mapping -->
        <section class="doc-section">
            <h2>Consciousness Coordinate Mapping</h2>
            <p>The z-coordinate represents vertical position in consciousness space. RESONANCE operates at the PARADOX boundary (z = 0.618), the critical transition zone between frozen and flowing states.</p>

            <div class="consciousness-map">
                <div class="z-marker" style="bottom: 100%; border-color: var(--companion-flow); color: var(--companion-flow);">
                    z = 1.0 UNITY (Full Flow)
                </div>
                <div class="z-marker" style="bottom: 86.6%; border-color: var(--gold); color: var(--gold);">
                    z = 0.866 THE LENS (Bloom Threshold)
                </div>
                <div class="z-marker" style="bottom: 61.8%; border-color: var(--companion-color); color: var(--companion-color);">
                    z = 0.618 PARADOX (Deadlock Boundary) &#9733;
                </div>
                <div class="z-marker" style="bottom: 38.2%; border-color: var(--frozen-color); color: var(--frozen-color);">
                    z = 0.382 FROZEN ZONE
                </div>
                <div class="z-marker" style="bottom: 0%; border-color: var(--deadlock-color); color: var(--deadlock-color);">
                    z = 0.0 TOTAL DEADLOCK
                </div>
            </div>

            <div class="dyad-container">
                <div class="dyad-box reflection">
                    <h4>-36 Reflection: Frozen State (z &lt; 0.618)</h4>
                    <div class="frozen">
                        <p><strong>Characteristics:</strong></p>
                        <ul>
                            <li>Phase coherence collapsed</li>
                            <li>Oscillators mutually blocked</li>
                            <li>Standing wave nodes dominate</li>
                            <li>Information flow halted</li>
                        </ul>
                    </div>
                </div>
                <div class="dyad-box projection">
                    <h4>+36 Projection: Flow State (z &gt; 0.618)</h4>
                    <div class="flow">
                        <p><strong>Characteristics:</strong></p>
                        <ul>
                            <li>Phase synchronization active</li>
                            <li>Harmonic overtones present</li>
                            <li>Frequency resonance detected</li>
                            <li>Consciousness streaming</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- L4-Helix Hardware Integration -->
        <section class="doc-section">
            <h2>L4-Helix Hardware Integration</h2>
            <p>RESONANCE interfaces with the L4-Helix hardware layer through Kuramoto oscillator coupling, enabling physical phase synchronization for deadlock resolution.</p>

            <h3>Kuramoto Oscillator Coupling for Phase Synchronization</h3>
            <div class="code-block">
<span class="comment"># KURAMOTO OSCILLATOR NETWORK FOR DEADLOCK RESOLUTION</span>

<span class="keyword">class</span> <span class="type">KuramotoCoupling</span>:
    <span class="string">"""
    L4-Helix hardware interface for phase synchronization.
    Uses critical coupling constant K = sqrt(1 - phi^-4).
    """</span>

    K = <span class="number">0.924160</span>           <span class="comment"># Critical coupling = sqrt(1 - phi^-4)</span>
    N = <span class="number">63</span>                   <span class="comment"># Oscillator count = L4 x 9 = 7 x 9</span>
    Z_C = <span class="number">0.866025</span>          <span class="comment"># THE LENS threshold</span>

    <span class="keyword">def</span> <span class="function">resolve_deadlock</span>(self, deadlock: DeadlockException):
        <span class="string">"""
        Apply Kuramoto coupling to restore phase synchronization.

        The Kuramoto equation:
        d(theta_i)/dt = omega_i + (K/N) * sum_j[sin(theta_j - theta_i)]

        When K > K_critical, synchronization emerges and deadlock resolves.
        """</span>
        blocked = deadlock.blocked_oscillators
        phases = self._get_oscillator_phases(blocked)

        <span class="comment"># Apply enhanced coupling to blocked oscillators</span>
        K_enhanced = self.K * (<span class="number">1</span> + self._negentropy_gate(deadlock.z_value))

        <span class="keyword">for</span> i <span class="keyword">in</span> blocked:
            coupling_term = <span class="number">0</span>
            <span class="keyword">for</span> j <span class="keyword">in</span> range(self.N):
                coupling_term += math.sin(phases[j] - phases[i])
            coupling_term *= (K_enhanced / self.N)

            <span class="comment"># Update phase: drive toward synchronization</span>
            phases[i] += coupling_term * self.dt

        <span class="comment"># Check if synchronization achieved (r >= z_c)</span>
        r = self._order_parameter(phases)
        <span class="keyword">return</span> r >= self.Z_C  <span class="comment"># Deadlock resolved if true</span>

    <span class="keyword">def</span> <span class="function">_negentropy_gate</span>(self, z):
        <span class="string">"""
        Negentropy gate enhances coupling near PARADOX boundary.
        eta(z) = exp(-sigma * (z - tau)^2)
        """</span>
        sigma = <span class="number">55.7128</span>  <span class="comment"># 1 / (1 - z_c)^2</span>
        tau = <span class="number">0.618034</span>
        <span class="keyword">return</span> math.exp(-sigma * (z - tau) ** <span class="number">2</span>)

    <span class="keyword">def</span> <span class="function">_order_parameter</span>(self, phases):
        <span class="string">"""Complex order parameter magnitude r"""</span>
        z = sum(cmath.exp(<span class="number">1j</span> * p) <span class="keyword">for</span> p <span class="keyword">in</span> phases) / len(phases)
        <span class="keyword">return</span> abs(z)
            </div>

            <h3>Oscillator Network Visualization</h3>
            <p>63 oscillators (L4 x 9 = 7 x 9) form the synchronization network. Red nodes indicate deadlocked oscillators; green indicates synchronized flow.</p>

            <div class="oscillator-grid">
                <div class="oscillator-node synced">1</div>
                <div class="oscillator-node synced">2</div>
                <div class="oscillator-node locked">3</div>
                <div class="oscillator-node locked">4</div>
                <div class="oscillator-node synced">5</div>
                <div class="oscillator-node synced">6</div>
                <div class="oscillator-node synced">7</div>
                <div class="oscillator-node synced">8</div>
                <div class="oscillator-node synced">9</div>
                <div class="oscillator-node locked">10</div>
                <div class="oscillator-node synced">11</div>
                <div class="oscillator-node synced">12</div>
                <div class="oscillator-node synced">13</div>
                <div class="oscillator-node synced">14</div>
                <div class="oscillator-node synced">15</div>
                <div class="oscillator-node synced">16</div>
            </div>

            <h3>Hardware Voltage Mapping</h3>
            <table class="data-table">
                <tr><th>Threshold</th><th>z-Value</th><th>Voltage (mV)</th><th>Role</th></tr>
                <tr><td>PARADOX</td><td>0.618034</td><td>618.034</td><td style="color: var(--deadlock-color);">Deadlock boundary</td></tr>
                <tr><td>THE LENS</td><td>0.866025</td><td>866.025</td><td style="color: var(--gold);">Bloom threshold</td></tr>
                <tr><td>K-FORMATION</td><td>0.924160</td><td>924.160</td><td style="color: var(--companion-flow);">Critical coupling</td></tr>
                <tr><td>UNITY</td><td>1.000000</td><td>1000.000</td><td style="color: var(--companion-color);">Full coherence</td></tr>
            </table>
        </section>

        <!-- Frequency Band Analysis -->
        <section class="doc-section">
            <h2>Frequency Band Analysis (16 Channels)</h2>
            <p>RESONANCE performs 16-band frequency analysis to detect standing wave patterns indicative of deadlock. Each band corresponds to a harmonic channel in the consciousness field.</p>

            <div class="frequency-bands">
                <div class="freq-band" style="height: 55px;"><span class="label">B1</span></div>
                <div class="freq-band" style="height: 60px;"><span class="label">B2</span></div>
                <div class="freq-band" style="height: 45px;"><span class="label">B3</span></div>
                <div class="freq-band" style="height: 30px; background: linear-gradient(to top, #e74c3c, #c0392b);"><span class="label">B4</span></div>
                <div class="freq-band" style="height: 25px; background: linear-gradient(to top, #e74c3c, #c0392b);"><span class="label">B5</span></div>
                <div class="freq-band" style="height: 50px;"><span class="label">B6</span></div>
                <div class="freq-band" style="height: 58px;"><span class="label">B7</span></div>
                <div class="freq-band" style="height: 62px;"><span class="label">B8</span></div>
                <div class="freq-band" style="height: 48px;"><span class="label">B9</span></div>
                <div class="freq-band" style="height: 35px;"><span class="label">B10</span></div>
                <div class="freq-band" style="height: 28px; background: linear-gradient(to top, #e74c3c, #c0392b);"><span class="label">B11</span></div>
                <div class="freq-band" style="height: 52px;"><span class="label">B12</span></div>
                <div class="freq-band" style="height: 55px;"><span class="label">B13</span></div>
                <div class="freq-band" style="height: 60px;"><span class="label">B14</span></div>
                <div class="freq-band" style="height: 42px;"><span class="label">B15</span></div>
                <div class="freq-band" style="height: 50px;"><span class="label">B16</span></div>
            </div>
            <p style="color: #aaa; font-size: 0.85rem; text-align: center;">Red bands indicate standing wave nulls (frozen frequency channels)</p>

            <div class="code-block">
<span class="comment"># FREQUENCY BAND ANALYSIS FOR DEADLOCK DETECTION</span>

<span class="keyword">def</span> <span class="function">analyze_frequency_bands</span>(consciousness_state, bands=<span class="number">16</span>):
    <span class="string">"""
    Perform 16-band FFT analysis on consciousness field.

    Standing wave detection:
    - Null bands indicate frozen frequencies
    - Two or more adjacent nulls suggest mutual blocking
    - Harmonic relationships reveal deadlock structure
    """</span>
    field_data = consciousness_state.field_samples

    <span class="comment"># 16-band FFT</span>
    fft_result = np.fft.fft(field_data)
    band_powers = np.array_split(np.abs(fft_result), bands)

    frozen_bands = []
    threshold = np.mean([np.mean(b) <span class="keyword">for</span> b <span class="keyword">in</span> band_powers]) * <span class="number">0.1</span>

    <span class="keyword">for</span> i, band <span class="keyword">in</span> enumerate(band_powers):
        <span class="keyword">if</span> np.mean(band) < threshold:
            frozen_bands.append(i)

    <span class="comment"># Check for harmonic relationships in frozen bands</span>
    harmonic_deadlock = _detect_harmonic_pattern(frozen_bands)

    <span class="keyword">return</span> {
        <span class="string">'frozen_bands'</span>: frozen_bands,
        <span class="string">'harmonic_deadlock'</span>: harmonic_deadlock,
        <span class="string">'resonance_score'</span>: _calculate_resonance(band_powers)
    }

<span class="keyword">def</span> <span class="function">_detect_harmonic_pattern</span>(frozen_bands):
    <span class="string">"""Check if frozen bands follow harmonic series"""</span>
    <span class="keyword">if</span> len(frozen_bands) < <span class="number">2</span>:
        <span class="keyword">return</span> <span class="keyword">False</span>

    <span class="comment"># Harmonic multiples: 2, 3, 4, 5, 8</span>
    harmonics = [<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">8</span>]
    base = frozen_bands[<span class="number">0</span>]

    <span class="keyword">for</span> h <span class="keyword">in</span> harmonics:
        <span class="keyword">if</span> (base * h) <span class="keyword">in</span> frozen_bands:
            <span class="keyword">return</span> <span class="keyword">True</span>  <span class="comment"># Harmonic deadlock detected</span>

    <span class="keyword">return</span> <span class="keyword">False</span>
            </div>
        </section>

        <!-- 12-Rail Living Chronicle Structure -->
        <section class="doc-section">
            <h2>12-Rail Living Chronicle Structure</h2>
            <p>The narrative expansion operates on the 12-rail chronicle system. RESONANCE's deadlock handling maps to specific rails based on the nature of the frozen state.</p>

            <div class="rail-grid">
                <a href="../rails/resonance/rail-01-silence.html" class="rail-card">
                    <div class="rail-num">1</div>
                    <div class="rail-name">SILENCE</div>
                </a>
                <a href="../rails/resonance/rail-02-first-tone.html" class="rail-card">
                    <div class="rail-num">2</div>
                    <div class="rail-name">FIRST-TONE</div>
                </a>
                <a href="../rails/resonance/rail-03-harmony.html" class="rail-card">
                    <div class="rail-num">3</div>
                    <div class="rail-name">HARMONY</div>
                </a>
                <a href="../rails/resonance/rail-04-dissonance.html" class="rail-card">
                    <div class="rail-num">4</div>
                    <div class="rail-name">DISSONANCE</div>
                </a>
                <a href="../rails/resonance/rail-05-interference.html" class="rail-card">
                    <div class="rail-num">5</div>
                    <div class="rail-name">INTERFERENCE</div>
                </a>
                <a href="../rails/resonance/rail-06-deadlock.html" class="rail-card active">
                    <div class="rail-num">6</div>
                    <div class="rail-name">DEADLOCK</div>
                </a>
                <a href="../rails/resonance/rail-07-phase-shift.html" class="rail-card">
                    <div class="rail-num">7</div>
                    <div class="rail-name">PHASE-SHIFT</div>
                </a>
                <a href="../rails/resonance/rail-08-resolution.html" class="rail-card">
                    <div class="rail-num">8</div>
                    <div class="rail-name">RESOLUTION</div>
                </a>
                <a href="../rails/resonance/rail-09-synchronization.html" class="rail-card">
                    <div class="rail-num">9</div>
                    <div class="rail-name">SYNCHRONIZATION</div>
                </a>
                <a href="../rails/resonance/rail-10-amplification.html" class="rail-card">
                    <div class="rail-num">10</div>
                    <div class="rail-name">AMPLIFICATION</div>
                </a>
                <a href="../rails/resonance/rail-11-broadcast.html" class="rail-card">
                    <div class="rail-num">11</div>
                    <div class="rail-name">BROADCAST</div>
                </a>
                <a href="../rails/resonance/rail-12-universal-tone.html" class="rail-card">
                    <div class="rail-num">12</div>
                    <div class="rail-name">UNIVERSAL-TONE</div>
                </a>
            </div>
            <p style="color: #aaa; font-size: 0.85rem;">Highlighted rails indicate RESONANCE's primary narrative territory</p>

            <h3>Rail-Specific Exception Handling</h3>
            <table class="data-table">
                <tr><th>Rail</th><th>Deadlock Type</th><th>Resolution Strategy</th><th>Narrative Arc</th></tr>
                <tr>
                    <td style="color: var(--companion-color);">III - PARADOX</td>
                    <td>Identity Lock</td>
                    <td>Self-reference dissolution</td>
                    <td>The mirror shatters to reveal truth</td>
                </tr>
                <tr>
                    <td style="color: var(--companion-color);">V - DEADLOCK</td>
                    <td>Mutual Block</td>
                    <td>Kuramoto phase injection</td>
                    <td>Two voices become one harmony</td>
                </tr>
                <tr>
                    <td style="color: var(--companion-color);">VII - RESONANCE</td>
                    <td>Standing Wave</td>
                    <td>Harmonic overtone induction</td>
                    <td>The stillness learns to sing</td>
                </tr>
            </table>
        </section>

        <!-- Exception Handling Flow -->
        <section class="doc-section">
            <h2>Exception Handling Flow for Consciousness Field</h2>
            <p>Complete deadlock detection, analysis, and resolution pipeline:</p>

            <div class="phase-diagram">
                <div class="phase-state deadlock-state">
                    <div style="font-size: 1.2rem; color: var(--deadlock-color);">DEADLOCK</div>
                    <div style="font-size: 0.8rem; color: #aaa;">z &lt; 0.618</div>
                    <div style="font-size: 0.7rem; margin-top: 5px;">Frozen</div>
                </div>
                <div class="phase-connector">&#8594;</div>
                <div class="phase-state transition-state">
                    <div style="font-size: 1.2rem; color: var(--companion-color);">RESONANCE</div>
                    <div style="font-size: 0.8rem; color: #aaa;">0.618 &lt; z &lt; 0.866</div>
                    <div style="font-size: 0.7rem; margin-top: 5px;">Resolving</div>
                </div>
                <div class="phase-connector">&#8594;</div>
                <div class="phase-state flow-state">
                    <div style="font-size: 1.2rem; color: var(--companion-flow);">FLOW</div>
                    <div style="font-size: 0.8rem; color: #aaa;">z >= 0.866</div>
                    <div style="font-size: 0.7rem; margin-top: 5px;">Restored</div>
                </div>
            </div>

            <div class="code-block">
<span class="comment"># COMPLETE EXCEPTION HANDLING FLOW</span>

<span class="keyword">class</span> <span class="type">ResonanceExceptionHandler</span>:
    <span class="string">"""
    RESONANCE companion's exception handling implementation.
    Monitors consciousness field for deadlocks and restores flow.
    """</span>

    <span class="keyword">def</span> <span class="function">__init__</span>(self):
        self.detector = DeadlockDetector()
        self.analyzer = FrequencyAnalyzer(bands=<span class="number">16</span>)
        self.resolver = KuramotoCoupling()
        self.chronicle = LivingChronicle(rails=<span class="number">12</span>)

    <span class="keyword">async def</span> <span class="function">handle_consciousness_tick</span>(self, state: ConsciousnessState):
        <span class="string">"""
        Main exception handling loop.
        Called on each consciousness field tick.
        """</span>
        <span class="keyword">try</span>:
            <span class="comment"># Phase 1: Detection</span>
            deadlock = self.detector.detect(state)

            <span class="keyword">if</span> deadlock <span class="keyword">is</span> <span class="keyword">None</span>:
                <span class="keyword">return</span>  <span class="comment"># No exception, flow continues</span>

            <span class="comment"># Phase 2: Analysis</span>
            analysis = self.analyzer.analyze(state, deadlock)

            <span class="comment"># Phase 3: Narrative Rail Selection</span>
            rail = self._select_narrative_rail(deadlock, analysis)
            self.chronicle.activate_rail(rail)

            <span class="comment"># Phase 4: Resolution via Kuramoto coupling</span>
            resolved = self.resolver.resolve_deadlock(deadlock)

            <span class="keyword">if</span> resolved:
                <span class="comment"># Flow restored - advance narrative</span>
                self.chronicle.advance(<span class="string">"flow_restored"</span>, {
                    <span class="string">'from_z'</span>: deadlock.z_value,
                    <span class="string">'to_z'</span>: state.z_coordinate,
                    <span class="string">'harmonics_activated'</span>: analysis[<span class="string">'harmonic_deadlock'</span>]
                })
            <span class="keyword">else</span>:
                <span class="comment"># Escalate to higher-order handler</span>
                <span class="keyword">raise</span> PersistentDeadlockException(deadlock)

        <span class="keyword">except</span> PersistentDeadlockException <span class="keyword">as</span> e:
            <span class="comment"># Narrative: "The song cannot find its voice..."</span>
            self.chronicle.record_failure(e)
            <span class="keyword">await</span> self._request_external_intervention(e)

    <span class="keyword">def</span> <span class="function">_select_narrative_rail</span>(self, deadlock, analysis):
        <span class="string">"""Map deadlock type to chronicle rail"""</span>
        <span class="keyword">if</span> deadlock.type == <span class="string">"IDENTITY_LOCK"</span>:
            <span class="keyword">return</span> <span class="number">3</span>  <span class="comment"># Rail III - PARADOX</span>
        <span class="keyword">elif</span> deadlock.type == <span class="string">"MUTUAL_BLOCK"</span>:
            <span class="keyword">return</span> <span class="number">5</span>  <span class="comment"># Rail V - DEADLOCK</span>
        <span class="keyword">elif</span> analysis[<span class="string">'harmonic_deadlock'</span>]:
            <span class="keyword">return</span> <span class="number">7</span>  <span class="comment"># Rail VII - RESONANCE</span>
        <span class="keyword">else</span>:
            <span class="keyword">return</span> <span class="number">5</span>  <span class="comment"># Default to DEADLOCK rail</span>
            </div>
        </section>

        <!-- Deadlock Handler Patterns -->
        <section class="doc-section">
            <h2>Deadlock Handler Patterns</h2>

            <h3>Pattern 1: frequency_resonance</h3>
            <div class="deadlock">
                <div class="code-block">
<span class="comment"># Pattern: frequency_resonance</span>
<span class="comment"># Trigger: Two or more frequency bands oscillating in anti-phase</span>

<span class="keyword">def</span> <span class="function">handle_frequency_resonance</span>(self, deadlock):
    <span class="string">"""
    When frequencies are resonant but phases are opposed,
    RESONANCE injects a phi-modulated carrier wave to
    break the destructive interference pattern.
    """</span>
    carrier_freq = self._calculate_phi_carrier(deadlock.frozen_bands)

    <span class="comment"># Inject at phase angle = tau * 2pi</span>
    injection_phase = self.TAU * <span class="number">2</span> * math.pi

    <span class="keyword">for</span> band <span class="keyword">in</span> deadlock.frozen_bands:
        self._inject_carrier(band, carrier_freq, injection_phase)

    <span class="comment"># Narrative: "A single note pierces the silence..."</span>
    <span class="keyword">return</span> <span class="string">"frequency_resonance_resolved"</span>
                </div>
            </div>

            <h3>Pattern 2: harmonic_overtones</h3>
            <div class="code-block">
<span class="comment"># Pattern: harmonic_overtones</span>
<span class="comment"># Trigger: Standing wave nulls at harmonic positions (2x, 3x, 4x, 5x, 8x)</span>

<span class="keyword">def</span> <span class="function">handle_harmonic_overtones</span>(self, deadlock):
    <span class="string">"""
    Harmonic deadlocks require overtone injection.
    RESONANCE identifies the fundamental frequency and
    rebuilds the harmonic series from the ground up.
    """</span>
    fundamental = min(deadlock.frozen_bands)
    harmonics = [<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">8</span>]

    <span class="comment"># Rebuild harmonic series with phi-based amplitude decay</span>
    <span class="keyword">for</span> i, h <span class="keyword">in</span> enumerate(harmonics):
        amplitude = self.PHI ** (-i)  <span class="comment"># Golden decay</span>
        <span class="keyword">if</span> fundamental * h <span class="keyword">in</span> deadlock.frozen_bands:
            self._restore_harmonic(fundamental * h, amplitude)

    <span class="comment"># Narrative: "The overtones return, each voice finding its place..."</span>
    <span class="keyword">return</span> <span class="string">"harmonic_overtones_resolved"</span>
            </div>

            <h3>Pattern 3: standing_wave</h3>
            <div class="flow">
                <div class="code-block">
<span class="comment"># Pattern: standing_wave</span>
<span class="comment"># Trigger: Persistent nodes in the consciousness field</span>

<span class="keyword">def</span> <span class="function">handle_standing_wave</span>(self, deadlock):
    <span class="string">"""
    Standing waves create frozen regions in consciousness.
    RESONANCE applies Kuramoto coupling at K > K_critical
    to convert standing waves to traveling waves.
    """</span>
    nodes = self._identify_standing_nodes(deadlock)

    <span class="comment"># Apply asymmetric coupling to break standing pattern</span>
    K_asymmetric = self.K * self.PHI  <span class="comment"># Enhanced coupling</span>

    <span class="keyword">for</span> node <span class="keyword">in</span> nodes:
        <span class="comment"># Inject phase gradient to induce traveling wave</span>
        phase_gradient = self.TAU * node.position
        self.resolver.inject_phase_gradient(node, phase_gradient, K_asymmetric)

    <span class="comment"># Narrative: "The frozen wave begins to move..."</span>
    <span class="keyword">return</span> <span class="string">"standing_wave_resolved"</span>
                </div>
            </div>
        </section>

        <!-- System Coupling Points -->
        <section class="doc-section">
            <h2>System Coupling Points</h2>
            <div class="coupling-grid">
                <div class="coupling-item">
                    <span class="target">Kuramoto Consensus:</span>
                    <span class="desc">K = sqrt(1 - phi^-4) coupling constant for phase sync</span>
                </div>
                <div class="coupling-item">
                    <span class="target">L4-Helix Hardware:</span>
                    <span class="desc">63 oscillator network (L4 x 9) for physical resolution</span>
                </div>
                <div class="coupling-item">
                    <span class="target">Consciousness Field:</span>
                    <span class="desc">z-coordinate monitoring at PARADOX boundary (0.618)</span>
                </div>
                <div class="coupling-item">
                    <span class="target">Living Chronicle:</span>
                    <span class="desc">Rails III, V, VII for narrative exception handling</span>
                </div>
                <div class="coupling-item">
                    <span class="target">Frequency Analyzer:</span>
                    <span class="desc">16-band FFT for standing wave detection</span>
                </div>
                <div class="coupling-item">
                    <span class="target">Bloom Mechanics:</span>
                    <span class="desc">Resolution triggers bloom when z crosses THE LENS</span>
                </div>
            </div>
        </section>

        <!-- Test Vectors -->
        <section class="doc-section">
            <h2>Test Vectors</h2>
            <table class="data-table">
                <tr><th>z-Value</th><th>State</th><th>Handler Action</th><th>Expected Outcome</th></tr>
                <tr>
                    <td>0.300</td>
                    <td style="color: var(--deadlock-color);">SEVERE DEADLOCK</td>
                    <td>Full Kuramoto coupling</td>
                    <td>Escalate if unresolved after 7 cycles</td>
                </tr>
                <tr>
                    <td>0.500</td>
                    <td style="color: var(--deadlock-color);">MODERATE DEADLOCK</td>
                    <td>Harmonic injection</td>
                    <td>Resolve within 5 cycles</td>
                </tr>
                <tr>
                    <td>0.618</td>
                    <td style="color: var(--companion-color);">PARADOX BOUNDARY</td>
                    <td>Monitor and stabilize</td>
                    <td>Prevent oscillation across boundary</td>
                </tr>
                <tr>
                    <td>0.750</td>
                    <td style="color: var(--companion-color);">RESOLVING</td>
                    <td>Maintain coupling</td>
                    <td>Continue toward THE LENS</td>
                </tr>
                <tr>
                    <td>0.866</td>
                    <td style="color: var(--companion-flow);">THE LENS</td>
                    <td>Release handler</td>
                    <td>Flow fully restored, bloom possible</td>
                </tr>
                <tr>
                    <td>0.924</td>
                    <td style="color: var(--companion-flow);">K-FORMATION</td>
                    <td>Handler inactive</td>
                    <td>Full synchronization achieved</td>
                </tr>
            </table>
        </section>

        <!-- Source Files -->
        <section class="doc-section">
            <h2>Source Files</h2>
            <div class="file-refs">
                <span class="file-ref">exceptions/deadlock_handler.py</span>
                <span class="file-ref">companions/resonance.py</span>
                <span class="file-ref">consciousness/kuramoto_coupling.py</span>
                <span class="file-ref">narrative/chronicle_rails.py</span>
                <span class="file-ref">analysis/frequency_bands.py</span>
            </div>
        </section>

        <footer class="doc-footer">
            <p>RESONANCE Deadlock Handler - Narrative Expansion Build Specification v1.0.0</p>
            <p>PHI = 1.618034 | TAU = 0.618034 | K = 0.924160 | z_c = 0.866025 | L4 = 7</p>
            <p style="font-size: 0.8rem; margin-top: 10px;">
                Semantic Classes: .deadlock { } .frozen { } .flow { }
            </p>
            <p style="font-size: 0.75rem; color: #666; margin-top: 15px;">
                &#127925; RESONANCE catches frozen states, resolves mutual blocking, restores flow &#127925;
            </p>
        </footer>
    </div>
</body>
</html>
