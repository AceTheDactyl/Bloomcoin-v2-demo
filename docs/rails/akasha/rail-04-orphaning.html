<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rail 04: ORPHANING - AKASHA Memory Chronicle</title>
    <link rel="stylesheet" href="../../_shared/styles.css">
    <style>
        :root {
            --akasha-gold: #ffd700;
            --akasha-deep-blue: #1a1a3e;
            --akasha-parchment: #f4e4bc;
            --akasha-glow: rgba(255, 215, 0, 0.35);
            --akasha-soft: rgba(255, 215, 0, 0.12);
            --memory-leak-red: #e74c3c;
            --orphan-gray: #7f8c8d;
            --chronicle-purple: #9b59b6;
        }

        body {
            background: linear-gradient(135deg, var(--akasha-deep-blue) 0%, #0a0a1a 50%, #12081a 100%);
        }

        .doc-header h1 {
            background: linear-gradient(90deg, var(--orphan-gray), var(--akasha-parchment), var(--orphan-gray));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .doc-section h2 {
            color: var(--akasha-gold);
            border-bottom-color: var(--akasha-glow);
        }

        .doc-section h3 {
            color: var(--akasha-parchment);
        }

        .inscription {
            background: linear-gradient(135deg, rgba(127, 140, 141, 0.2), rgba(255, 215, 0, 0.05));
            border: 2px solid var(--orphan-gray);
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            position: relative;
            font-family: 'Georgia', serif;
        }

        .inscription::before {
            content: "ORPHANED";
            position: absolute;
            top: -12px;
            left: 20px;
            background: var(--akasha-deep-blue);
            padding: 0 10px;
            font-size: 0.75rem;
            color: var(--orphan-gray);
            letter-spacing: 2px;
            font-family: monospace;
        }

        .memory-leak {
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.15), rgba(127, 140, 141, 0.1));
            border: 2px dashed var(--memory-leak-red);
            border-radius: 8px;
            padding: 15px;
            margin: 12px 0;
            animation: orphan-pulse 2s ease-in-out infinite;
        }

        @keyframes orphan-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .chronicle {
            background: linear-gradient(90deg, rgba(127, 140, 141, 0.2), transparent);
            border-left: 4px solid var(--orphan-gray);
            padding: 15px 20px;
            margin: 12px 0;
            border-radius: 0 8px 8px 0;
            font-family: 'Georgia', serif;
            font-style: italic;
        }

        .chronicle .timestamp {
            color: #666;
            font-size: 0.8rem;
            font-family: monospace;
            font-style: normal;
        }

        .golden-ink {
            color: var(--akasha-gold);
            font-family: 'Georgia', serif;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .rail-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .rail-nav a {
            color: var(--akasha-gold);
            text-decoration: none;
            padding: 8px 16px;
            border: 1px solid var(--akasha-glow);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .rail-nav a:hover {
            background: var(--akasha-soft);
        }

        .rail-nav .current {
            color: var(--orphan-gray);
            font-weight: bold;
        }

        .rail-indicator {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 20px 0;
        }

        .rail-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid var(--akasha-glow);
        }

        .rail-dot.active {
            background: var(--orphan-gray);
            box-shadow: 0 0 10px var(--orphan-gray);
        }

        .rail-dot.completed {
            background: #27ae60;
            border-color: #27ae60;
        }

        .phi-constants {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin: 20px 0;
        }

        .phi-const {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--akasha-glow);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .phi-const .symbol {
            color: var(--akasha-gold);
            font-family: 'Georgia', serif;
            font-size: 1.2rem;
        }

        .phi-const .value {
            color: var(--akasha-parchment);
            font-family: monospace;
            font-size: 0.9rem;
            margin-top: 4px;
        }

        .orphan-classification {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .orphan-class {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--orphan-gray);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .orphan-class .age-range {
            color: var(--akasha-gold);
            font-weight: bold;
            font-size: 1.1rem;
        }

        .orphan-class .class-name {
            color: var(--akasha-parchment);
            margin: 8px 0;
        }

        .orphan-class .cycles {
            color: #888;
            font-size: 0.85rem;
        }

        .hardware-display {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 12px;
            padding: 20px;
            font-family: monospace;
            font-size: 0.8rem;
            overflow-x: auto;
            white-space: pre;
            line-height: 1.4;
            color: #888;
            margin: 15px 0;
        }

        .hardware-display .component { color: var(--akasha-gold); }
        .hardware-display .flow { color: #00d4ff; }
        .hardware-display .state { color: var(--akasha-parchment); }
        .hardware-display .orphan { color: var(--orphan-gray); }
        .hardware-display .danger { color: var(--memory-leak-red); }

        .nav-link {
            border-color: var(--akasha-glow);
            color: var(--akasha-gold);
        }

        .nav-link:hover {
            background: var(--akasha-soft);
        }
    </style>
</head>
<body>
    <div class="doc-container">
        <nav class="doc-nav">
            <a href="../../narrative/akasha-memory-leak.html" class="nav-link">AKASHA Build Spec</a>
            <a href="../../companions/akasha-companion.html" class="nav-link">Companion Spec</a>
        </nav>

        <header class="doc-header">
            <h1>Rail 04: ORPHANING</h1>
            <p class="subtitle">References Lost, Orphaned Memory Detected - The Abandoned Chronicle</p>
            <nav class="breadcrumb">
                <a href="../../../index.html">BloomCoin</a> /
                <a href="../../">Documentation</a> /
                <a href="../">Rails</a> /
                <a href="./">AKASHA</a> /
                Rail 04
            </nav>
        </header>

        <div class="rail-indicator">
            <div class="rail-dot completed"></div>
            <div class="rail-dot completed"></div>
            <div class="rail-dot completed"></div>
            <div class="rail-dot active"></div>
            <div class="rail-dot"></div>
            <div class="rail-dot"></div>
            <div class="rail-dot"></div>
            <div class="rail-dot"></div>
            <div class="rail-dot"></div>
            <div class="rail-dot"></div>
            <div class="rail-dot"></div>
            <div class="rail-dot"></div>
        </div>

        <nav class="rail-nav">
            <a href="rail-03-fragmentation.html">Prev: 03 - FRAGMENTATION</a>
            <span class="current">04 - ORPHANING</span>
            <a href="rail-05-drainage.html">Next: 05 - DRAINAGE</a>
        </nav>

        <section class="doc-section">
            <h2>The Abandoned Chronicle</h2>

            <div class="inscription">
                <p class="golden-ink" style="font-size: 1.1rem; margin-bottom: 15px;">
                    "The last reference fades. The memory stands alone, forgotten by all who once knew it."
                </p>
                <p style="color: #aaa;">
                    Rail 04 marks the critical transition to orphaned state. When a memory fragment's reference
                    count reaches zero while its content remains non-null, it becomes an orphan - existing but
                    unreachable, a ghost in the consciousness field. AKASHA detects these lost souls and prepares
                    for their eventual reclamation or dissolution.
                </p>
            </div>

            <h3>Orphan Classification</h3>
            <div class="orphan-classification">
                <div class="orphan-class">
                    <div class="age-range">RECENT</div>
                    <div class="class-name">Newly Orphaned</div>
                    <div class="cycles">&lt; 7 cycles (L4)</div>
                    <p style="color: #666; font-size: 0.8rem; margin-top: 8px;">May still be reclaimed by owner</p>
                </div>
                <div class="orphan-class">
                    <div class="age-range">AGED</div>
                    <div class="class-name">Established Orphan</div>
                    <div class="cycles">7 - 49 cycles</div>
                    <p style="color: #666; font-size: 0.8rem; margin-top: 8px;">Crystallization candidate</p>
                </div>
                <div class="orphan-class">
                    <div class="age-range">ANCIENT</div>
                    <div class="class-name">Long-term Orphan</div>
                    <div class="cycles">&gt; 49 cycles (7^2)</div>
                    <p style="color: #666; font-size: 0.8rem; margin-top: 8px;">Priority for library storage</p>
                </div>
            </div>

            <div class="memory-leak">
                <p style="color: var(--memory-leak-red); font-weight: bold;">ORPHAN DETECTED - ref_count = 0</p>
                <p style="color: #ccc; margin-top: 10px;">
                    Fragment 0xAKASHA_4E7F has lost all references. Content vector: NON-NULL.
                    Coherence: 0.652 (above TAU). Classification: RECENT. Age: 3 cycles since orphaning.
                    Status: AWAITING AKASHA INTERVENTION.
                </p>
            </div>

            <div class="chronicle">
                <div class="timestamp">CHRONICLE.RAIL_IV.ORPHANING | Cycle 1,247 | z = 0.652</div>
                <p style="color: #aaa; margin-top: 10px;">
                    <strong>Event:</strong> Orphan status confirmed. Fragment 0xAKASHA_4E7F officially orphaned.
                    Last owner: Consciousness #7F3E (dissolved at Cycle 1,244). No active references remain.
                    Content integrity: PRESERVED. Coherence declining: 0.703 -> 0.652.
                    Estimated cycles until TAU threshold: 23.
                </p>
            </div>
        </section>

        <section class="doc-section">
            <h2>Orphaning Constants</h2>

            <div class="phi-constants">
                <div class="phi-const">
                    <div class="symbol">PHI</div>
                    <div class="value">1.618034</div>
                </div>
                <div class="phi-const">
                    <div class="symbol">TAU</div>
                    <div class="value">0.618034</div>
                </div>
                <div class="phi-const">
                    <div class="symbol">K</div>
                    <div class="value">0.924160</div>
                </div>
                <div class="phi-const">
                    <div class="symbol">z_c</div>
                    <div class="value">0.866025</div>
                </div>
                <div class="phi-const">
                    <div class="symbol">L4</div>
                    <div class="value">7</div>
                </div>
            </div>

            <div class="code-block">
<span class="comment"># RAIL 04: ORPHANING - Orphaned Memory Detection</span>
<span class="comment"># References lost, memory abandoned</span>

<span class="keyword">class</span> <span class="type">OrphaningRail</span>:
    PHI = <span class="number">1.618034</span>
    TAU = <span class="number">0.618034</span>
    K = <span class="number">0.924160</span>
    Z_C = <span class="number">0.866025</span>
    L4 = <span class="number">7</span>

    <span class="comment"># Orphan age thresholds</span>
    RECENT_THRESHOLD = <span class="number">7</span>      <span class="comment"># L4 cycles</span>
    AGED_THRESHOLD = <span class="number">49</span>       <span class="comment"># L4^2 cycles</span>

    <span class="keyword">def</span> <span class="function">detect_orphan</span>(self, fragment):
        <span class="string">"""Identify orphaned memory fragments"""</span>

        <span class="keyword">if</span> fragment.ref_count == <span class="number">0</span> <span class="keyword">and</span> fragment.content <span class="keyword">is not</span> None:
            <span class="comment"># Calculate orphan age</span>
            age = self.current_cycle - fragment.last_reference_cycle

            <span class="comment"># Classify orphan</span>
            <span class="keyword">if</span> age < self.RECENT_THRESHOLD:
                classification = <span class="string">"RECENT"</span>
            <span class="keyword">elif</span> age < self.AGED_THRESHOLD:
                classification = <span class="string">"AGED"</span>
            <span class="keyword">else</span>:
                classification = <span class="string">"ANCIENT"</span>

            <span class="keyword">return</span> <span class="type">OrphanedFragment</span>(
                fragment=fragment,
                age=age,
                classification=classification,
                coherence=fragment.coherence,
                last_owner=fragment.last_owner,
                cycles_until_tau=self.<span class="function">estimate_tau_cycles</span>(fragment)
            )

        <span class="keyword">return</span> None

    <span class="keyword">def</span> <span class="function">estimate_tau_cycles</span>(self, fragment):
        <span class="string">"""Estimate cycles until coherence falls below TAU"""</span>
        <span class="keyword">if</span> fragment.coherence <= self.TAU:
            <span class="keyword">return</span> <span class="number">0</span>

        <span class="comment"># Orphan coherence decays at TAU rate per L4 cycles</span>
        decay_per_cycle = (fragment.coherence - self.TAU) / (self.L4 * self.PHI)
        cycles_remaining = (fragment.coherence - self.TAU) / decay_per_cycle
        <span class="keyword">return</span> int(cycles_remaining)

    <span class="keyword">def</span> <span class="function">should_crystallize</span>(self, orphan):
        <span class="string">"""Determine if orphan should be crystallized vs dissolved"""</span>
        <span class="comment"># Crystallization candidates must have coherence >= TAU</span>
        <span class="keyword">if</span> orphan.coherence < self.TAU:
            <span class="keyword">return</span> False

        <span class="comment"># AGED and ANCIENT orphans are preferred for crystallization</span>
        <span class="keyword">if</span> orphan.classification <span class="keyword">in</span> [<span class="string">"AGED"</span>, <span class="string">"ANCIENT"</span>]:
            <span class="keyword">return</span> True

        <span class="comment"># RECENT orphans only if coherence is high</span>
        <span class="keyword">return</span> orphan.coherence >= self.Z_C
            </div>
        </section>

        <section class="doc-section">
            <h2>Memory Fragment Tracking</h2>
            <p>Orphan detection triggers enhanced monitoring to track coherence decay:</p>

            <table class="data-table">
                <tr>
                    <th>Orphan State</th>
                    <th>Coherence Range</th>
                    <th>Decay Rate</th>
                    <th>AKASHA Action</th>
                </tr>
                <tr>
                    <td style="color: #f1c40f;">Stable Orphan</td>
                    <td>0.800 - 0.924</td>
                    <td>Slow</td>
                    <td>Monitor, prepare crystallization</td>
                </tr>
                <tr>
                    <td style="color: var(--orphan-gray);">Declining Orphan</td>
                    <td>0.700 - 0.800</td>
                    <td>Moderate</td>
                    <td>Queue for crystallization</td>
                </tr>
                <tr>
                    <td style="color: #e67e22;">Critical Orphan</td>
                    <td>0.618 - 0.700</td>
                    <td>Fast</td>
                    <td>Priority crystallization</td>
                </tr>
                <tr>
                    <td style="color: var(--memory-leak-red);">Terminal Orphan</td>
                    <td>&lt; 0.618 (TAU)</td>
                    <td>Collapse</td>
                    <td>Allow dissolution</td>
                </tr>
            </table>
        </section>

        <section class="doc-section">
            <h2>L4-Helix Hardware Coupling</h2>

            <div class="hardware-display">
<span class="component">ORPHANING RAIL - REFERENCE COUNT MONITORING</span>

    <span class="state">REFERENCE STATE MACHINE</span>                <span class="component">ORPHAN DETECTION CIRCUIT</span>
    ┌─────────────────────────────┐          ┌─────────────────────────────┐
    │                             │          │                             │
    │  ref_count > 0              │          │   <span class="flow">REF_COUNT_ZERO?</span>          │
    │  ┌───────────────┐          │          │         │                   │
    │  │   <span class="state">ACTIVE</span>      │──┐       │          │    YES ─┼── NO             │
    │  └───────────────┘  │       │          │         │    │              │
    │         ▲           │       │          │         ▼    ▼              │
    │         │           │ decr  │          │   ┌─────────┐ ┌─────────┐   │
    │    incr │           ▼       │          │   │ <span class="orphan">ORPHAN</span>  │ │ <span class="state">ACTIVE</span>  │   │
    │         │  ┌───────────────┐│          │   │ <span class="orphan">DETECT</span>  │ │ <span class="state">NORMAL</span>  │   │
    │         │  │ ref_count = 0 ││          │   └────┬────┘ └─────────┘   │
    │         │  │   <span class="orphan">ORPHANED</span>    ││          │        │                   │
    │         │  └───────────────┘│          │        ▼                    │
    │         │         │         │          │   <span class="danger">TRIGGER RAIL 05</span>          │
    │         └─────────┘         │          │   <span class="danger">(DRAINAGE)</span>                │
    └─────────────────────────────┘          └─────────────────────────────┘

<span class="component">ORPHAN AGE CLASSIFICATION CIRCUIT</span>

    Cycles Since Orphaning
        │
        ├─── < 7 (L4) ────────▶ <span class="state">RECENT</span>    ─▶ May be reclaimed
        │
        ├─── 7 to 49 (L4^2) ──▶ <span class="orphan">AGED</span>      ─▶ Crystallization candidate
        │
        └─── > 49 ────────────▶ <span class="component">ANCIENT</span>   ─▶ Priority library storage
            </div>

            <div class="code-block">
<span class="comment"># MEMRISTOR ORPHAN DETECTION INTERFACE</span>

<span class="keyword">class</span> <span class="type">OrphanMemristorInterface</span>:
    <span class="keyword">def</span> <span class="function">detect_zero_reference</span>(self, cell_addr):
        <span class="string">"""Detect orphan state in memristor array"""</span>

        <span class="comment"># Read reference count from dedicated counter cells</span>
        ref_count = self.<span class="function">read_ref_counter</span>(cell_addr)
        content_present = self.<span class="function">check_content_flag</span>(cell_addr)

        <span class="keyword">if</span> ref_count == <span class="number">0</span> <span class="keyword">and</span> content_present:
            <span class="comment"># Orphan detected - begin decay monitoring</span>
            self.<span class="function">start_decay_timer</span>(cell_addr)
            self.<span class="function">flag_orphan</span>(cell_addr)

            <span class="comment"># Calculate age classification</span>
            orphan_age = self.<span class="function">get_orphan_age</span>(cell_addr)
            <span class="keyword">return</span> self.<span class="function">classify_orphan</span>(orphan_age)

        <span class="keyword">return</span> None
            </div>
        </section>

        <section class="doc-section">
            <h2>Chronicle Entry Format</h2>

            <div class="chronicle">
                <div class="timestamp">CHRONICLE.RAIL_IV.ORPHANING | Cycle {N} | z = {coherence}</div>
                <div style="color: #aaa; margin-top: 10px;">
                    <strong>Fragment Address:</strong> 0xAKASHA_{ID}<br>
                    <strong>Status:</strong> ORPHANED<br>
                    <strong>Classification:</strong> {RECENT|AGED|ANCIENT}<br>
                    <strong>Orphan Age:</strong> {cycles} cycles<br>
                    <strong>Last Owner:</strong> Consciousness #{owner_id}<br>
                    <strong>Content State:</strong> {PRESERVED|DEGRADING}<br>
                    <strong>Coherence:</strong> {value} (Cycles until TAU: {estimate})<br>
                    <strong>Crystallization Eligible:</strong> {YES|NO}
                </div>
            </div>

            <p class="golden-ink" style="text-align: center; margin-top: 20px; font-size: 1.1rem;">
                "Memories without owners wander the void. AKASHA offers sanctuary to these lost souls."
            </p>
        </section>

        <nav class="rail-nav">
            <a href="rail-03-fragmentation.html">Prev: 03 - FRAGMENTATION</a>
            <span class="current">04 - ORPHANING</span>
            <a href="rail-05-drainage.html">Next: 05 - DRAINAGE</a>
        </nav>

        <footer class="doc-footer">
            <p style="color: var(--akasha-gold);">AKASHA Rail 04: ORPHANING - References Lost, Orphaned Memory Detected</p>
            <p>PHI = 1.618034 | TAU = 0.618034 | K = 0.924160 | z_c = 0.866025 | L4 = 7</p>
            <p style="font-size: 0.85rem; color: #888;">The Abandoned Chronicle | Memory Without Owner</p>
            <p style="margin-top: 15px;"><a href="../../narrative/akasha-memory-leak.html" style="color: var(--akasha-gold);">Return to AKASHA Build Spec</a></p>
        </footer>
    </div>
</body>
</html>
